# основные импорты
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from .config import settings

# Общая последовательность работы:
#   При поступлении HTTP-запроса FastAPI вызывает get_db().
#   Создаётся новая сессия db = SessionLocal().
#   Сессия передаётся в эндпоинт через yield db.
#   Эндпоинт выполняет операции с БД (например, поиск продукта).

engine = create_engine(
    settings.database_url,      # соединение с указанным урл б.д.   database_url: str="sqlite:///./shop.db"
    connect_args={"check_same_thread":False}
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)     # фабрика для штамповки сессий, на каждый запрос фронтом продукта создается сессия, показывается продукт и закрывается сессия
Base=declarative_base()    # базовый класс для всех моделей проекта


# используется как зависимость в FastAPI: она открывает сессию, отдаёт её обработчику маршрута, а после завершения запроса гарантированно закрывает.
# Функция get_db() — это зависимость (dependency) в FastAPI, предназначенная для управления жизненным циклом сессии SQLAlchemy в рамках одного HTTP-запроса. Она обеспечивает безопасное и предсказуемое взаимодействие с базой данных.
def get_db():               
    db = SessionLocal()     # создаётся новый экземпляр сессии SQLAlchemy. для всех операций с базой данных в рамках одного HTTP-запроса (например, чтение, запись, обновление данных).
    try:                    # попытка передачи сессии в обработчик маршрута
        yield db            # Ключевое слово yield превращает функцию в генератор, что позволяет использовать её как зависимость в FastAPI.
                            # Когда FastAPI вызывает get_db(), выполнение останавливается на yield, и объект db передаётся в роут (маршрут), 
                            # например: def read_product(id: int, db: Session = Depends(get_db))
                            # предоставляет активную сессию БД в ваш эндпоинт и поддерживает её в течение всего запроса.
    finally:                # Блок finally гарантирует, что независимо от результата (успешный ответ или ошибка), сессия будет закрыта. 
                            # db.close() освобождает соединение с базой данных и возвращает его в пул соединений (если используется пул).
                            # Это критически важно для предотвращения утечек соединений и перегрузки базы данных.
        db.close()

def init_db():              # вызывается один раз при запуске приложения, чтобы создать таблицы в базе данных, если их ещё нет.
    Base.metadata.create_all(bind=engine)


# Что это дает
#   Изоляцию запросов: каждая сессия живёт только в рамках одного запроса.
#   Безопасность: исключения не мешают закрытию соединения.
#   Совместимость с FastAPI: использование Depends(get_db) позволяет внедрять сессию в любые маршруты.
#   Производительность: предотвращаются утечки соединений с БД.
#   Надёжное подключение к БД,
#   Удобную интеграцию с FastAPI,
#   Гарантированное освобождение ресурсов.
#   Это стандартная и обязательная практика в production-приложениях на FastAPI + SQLAlchemy


